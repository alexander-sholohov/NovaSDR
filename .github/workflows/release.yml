name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g. v0.1.0)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  build:
    name: build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            asset: linux-x86_64
            package_ext: tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            asset: windows-x86_64
            package_ext: zip
          - os: macos-14
            target: aarch64-apple-darwin
            asset: macos-aarch64
            package_ext: tar.gz
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.tag || github.ref }}
          submodules: recursive
          token: ${{ secrets.NOVA_SUBMODULES_TOKEN || github.token }}
      - name: Ensure tag points to main
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ inputs.tag || github.ref_name }}"
          git fetch --no-tags origin main
          TAG_COMMIT="$(git rev-list -n 1 "${TAG}")"
          if ! git merge-base --is-ancestor "${TAG_COMMIT}" "origin/main"; then
            echo "Release tags must point to a commit reachable from origin/main." >&2
            echo "Tag: ${TAG}" >&2
            echo "Tagged commit: ${TAG_COMMIT}" >&2
            exit 1
          fi
      - uses: dtolnay/rust-toolchain@stable
      # The frontend is a git submodule and ships with prebuilt artifacts in frontend/dist/.

      - name: Set optional environment variables (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: Add-Content -Path $env:GITHUB_ENV -Value "VCPKG_ROOT=C:\vcpkg\"

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            pkg-config \
            libsoapysdr-dev \
            soapysdr-tools \
            ocl-icd-opencl-dev \
            libclfft-dev \
            libopus-dev \
          || true

          # If libclfft-dev isn't available on the runner image, build clFFT from source so the
          # release binaries can still be built with --features clfft.
          if ! ldconfig -p 2>/dev/null | grep -qi clfft; then
            sudo apt-get install -y --no-install-recommends cmake build-essential git
            git clone --depth 1 https://github.com/clMathLibraries/clFFT.git /tmp/clfft
            cmake -S /tmp/clfft -B /tmp/clfft/build -DCMAKE_BUILD_TYPE=Release
            cmake --build /tmp/clfft/build -j"$(nproc)"
            sudo cmake --install /tmp/clfft/build
            sudo ldconfig || true
          fi

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail
          brew update
          brew install pkg-config soapysdr opus

      - name: Install system dependencies (Windows)
        if: runner.os == 'Windows'
        run: C:\vcpkg\vcpkg install opus --vcpkg-root C:\vcpkg

      - name: Verify frontend/dist exists
        shell: bash
        run: |
          set -euo pipefail
          test -f frontend/dist/index.html

      - name: Build backend
        shell: bash
        run: |
          TAG="${{ github.ref_name }}"
          if [[ -n "${{ inputs.tag }}" ]]; then TAG="${{ inputs.tag }}"; fi

          if [[ "${{ runner.os }}" == "Windows" ]]; then
            cargo build -p novasdr-server --release
            exit 0
          fi

          features="soapysdr"
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            features="soapysdr,clfft"
          fi

          NOVASDR_BUILD="${TAG}-${{ matrix.asset }}" \
            cargo build -p novasdr-server --release --features "${features}"

      - name: Package
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ github.ref_name }}"
          if [[ -n "${{ inputs.tag }}" ]]; then TAG="${{ inputs.tag }}"; fi

          PKG="novasdr-${TAG}-${{ matrix.asset }}"
          mkdir -p "dist/${PKG}"

          cp LICENSE NOTICE README.md "dist/${PKG}/"
          mkdir -p "dist/${PKG}/config"
          cp -R config/* "dist/${PKG}/config/" || true

          mkdir -p "dist/${PKG}/frontend"
          cp -R frontend/dist "dist/${PKG}/frontend/"

          if [[ "${{ runner.os }}" == "Windows" ]]; then
            cp "target/release/novasdr-server.exe" "dist/${PKG}/"
            (cd dist && 7z a "${PKG}.zip" "${PKG}" >/dev/null)
          else
            cp "target/release/novasdr-server" "dist/${PKG}/"
            (cd dist && tar -czf "${PKG}.tar.gz" "${PKG}")
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.asset }}
          path: dist/*

  build_rpi:
    name: build (raspberry pi)
    # Build an ARM64 (Raspberry Pi) binary using an ARM64 container on a regular x86_64 runner.
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.tag || github.ref }}
          submodules: recursive
          token: ${{ secrets.NOVA_SUBMODULES_TOKEN || github.token }}
      - name: Ensure tag points to main
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ inputs.tag || github.ref_name }}"
          git fetch --no-tags origin main
          TAG_COMMIT="$(git rev-list -n 1 "${TAG}")"
          if ! git merge-base --is-ancestor "${TAG_COMMIT}" "origin/main"; then
            echo "Release tags must point to a commit reachable from origin/main." >&2
            echo "Tag: ${TAG}" >&2
            echo "Tagged commit: ${TAG_COMMIT}" >&2
            exit 1
          fi
      - uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build and package (Pi / ARM64)
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ github.ref_name }}"
          if [[ -n "${{ inputs.tag }}" ]]; then TAG="${{ inputs.tag }}"; fi

          docker run --rm --platform linux/arm64 \
            -e NOVASDR_TAG="${TAG}" \
            -v "${PWD}:/workspace" \
            -w /workspace \
            debian:trixie \
            bash -lc '
              set -euo pipefail
              export DEBIAN_FRONTEND=noninteractive

              apt-get update
              apt-get install -y --no-install-recommends \
                ca-certificates \
                curl \
                cmake \
                g++ \
                git \
                clang \
                llvm-dev \
                libclang-dev \
                make \
                pkg-config

              # Optional on ARM64 (depends on distro packaging).
              apt-get install -y --no-install-recommends \
                ocl-icd-opencl-dev \
                libclfft-dev \
                libopus-dev \
              || true

              # Build SoapySDR from source for build-time linking (we do not ship/bundle it).
              git clone --depth 1 https://github.com/pothosware/SoapySDR.git /tmp/SoapySDR
              cmake -S /tmp/SoapySDR -B /tmp/SoapySDR/build \
                -DCMAKE_BUILD_TYPE=Release \
                -DENABLE_PYTHON=OFF \
                -DENABLE_TESTS=OFF
              cmake --build /tmp/SoapySDR/build -j"$(nproc)"
              cmake --install /tmp/SoapySDR/build
              ldconfig || true

              curl https://sh.rustup.rs -sSf | sh -s -- -y --profile minimal --default-toolchain stable
              source "$HOME/.cargo/env"

              # soapysdr-sys uses bindgen at build time; ensure bindgen can find libclang.
              if command -v llvm-config >/dev/null 2>&1; then
                export LIBCLANG_PATH="$(llvm-config --libdir)"
              fi

              cd /workspace

              features="soapysdr"
              if ldconfig -p 2>/dev/null | grep -qi clfft; then
                features="${features},clfft"
              fi

              NOVASDR_BUILD="${NOVASDR_TAG}-raspberrypi-aarch64" \
                cargo build -p novasdr-server --release --features "${features}"

              PKG="novasdr-${NOVASDR_TAG}-raspberrypi-aarch64"
              rm -rf "dist/${PKG}"
              mkdir -p "dist/${PKG}/config" "dist/${PKG}/frontend"
              cp LICENSE NOTICE README.md "dist/${PKG}/"
              cp -R config/* "dist/${PKG}/config/" || true
              cp -R frontend/dist "dist/${PKG}/frontend/"
              cp "target/release/novasdr-server" "dist/${PKG}/"

              (cd dist && tar -czf "${PKG}.tar.gz" "${PKG}")
            '

      - uses: actions/upload-artifact@v4
        with:
          name: dist-raspberrypi-aarch64
          path: dist/*

  release:
    name: publish
    needs: [build, build_rpi]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.tag || github.ref }}
      - uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Release notes
        id: release_notes
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ inputs.tag || github.ref_name }}"
          git fetch --force --tags
          NOTES="$(git for-each-ref "refs/tags/${TAG}" --format="%(contents)" || true)"
          {
            echo "body<<EOF"
            echo "${NOTES}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag || github.ref_name }}
          generate_release_notes: false
          body: ${{ steps.release_notes.outputs.body }}
          files: |
            dist/**/*.zip
            dist/**/*.tar.gz
